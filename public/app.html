<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Craigslist-Compliant Ad Assistant</title>
<style>
:root{--bg:#0a0f1a;--card:#0f172a;--accent:#22d3ee;--accent2:#fbbf24;--text:#e5e7eb;--muted:#94a3b8;--ok:#34d399;--warn:#f59e0b;--bad:#ef4444}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;color:var(--text);background:radial-gradient(1200px 800px at 10% 0%, #0b1329, #05070c 60%)}
.wrap{max-width:1100px;margin:24px auto;padding:16px}
.header{display:flex;gap:16px;align-items:center}
.badge{padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1020;font-weight:700;font-size:12px;letter-spacing:.4px}
h1{margin:4px 0 0;font-size:22px}
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;margin-top:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.25);margin-top:18px}
.card h2{font-size:16px;margin:0 0 12px;color:#eaf2ff}
label{display:block;font-size:12px;color:var(--muted);margin:12px 0 6px}
input,textarea,select{width:100%;padding:10px 12px;background:#0b1222;border:1px solid rgba(255,255,255,.1);color:var(--text);border-radius:10px;outline:none}
textarea{min-height:160px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.help{font-size:12px;color:var(--muted)}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:#0b1020;background:var(--accent);box-shadow:0 4px 10px rgba(34,211,238,.35)}
button.alt{background:var(--accent2);box-shadow:0 4px 10px rgba(251,191,36,.35)}
button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.15)}
.checklist{display:grid;gap:8px}
.item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;background:#0b1222;border:1px solid rgba(255,255,255,.06)}
.dot{width:10px;height:10px;border-radius:50%}
.dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
.variants{display:grid;gap:10px;margin-top:10px}
.variant{border:1px dashed rgba(255,255,255,.15);border-radius:10px;padding:10px;background:rgba(255,255,255,.02)}
.muted{color:var(--muted);font-size:12px}
.small{font-size:11px}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.heat-grid{display:grid;grid-template-columns:60px repeat(24,1fr); gap:2px; align-items:center}
.heat-cell{height:16px; border-radius:3px; background:#0b1222; border:1px solid rgba(255,255,255,.06)}
.heat-label{font-size:10px; color:var(--muted); text-align:right; padding-right:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="badge">Compliant • No Loopholes</div>
      <h1>Craigslist-Compliant Ad Assistant</h1>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Ad Details</h2>
        <div class="row">
          <div><label>City / Area</label><input id="city" placeholder="e.g., Brisbane, QLD" /></div>
          <div><label>Category</label><select id="category">
            <option value="services">services</option>
            <option value="gigs">gigs</option>
            <option value="for sale">for sale</option>
            <option value="housing">housing</option>
            <option value="jobs">jobs (employer only – no affiliates)</option>
          </select></div>
        </div>
        <label>Offer Type</label><input id="offer" placeholder="e.g., Free info guide on [problem], short consult" />
        <label>Audience / Problem</label><input id="problem" placeholder="e.g., Busy homeowners needing same-day pest control" />
        <label>Solution / Value</label><input id="solution" placeholder="e.g., Short guide + options from verified providers" />
        <label>Headline Tone</label><select id="tone"><option value="plain">Plain</option><option value="friendly">Friendly</option><option value="urgent">Urgency-lite</option><option value="professional" selected>Professional</option></select>
        <div class="row">
          <div><label>Contact Method</label><select id="contact"><option value="reply">“Reply to this ad”</option><option value="call">Phone (enter in Notes)</option><option value="email">Email (enter in Notes)</option></select></div>
          <div><label>Length</label><select id="length"><option value="short">Short</option><option value="normal" selected>Normal</option><option value="long">Long</option></select></div>
        </div>
        <label>Info Page (your domain)</label><input id="url" placeholder="https://yourdomain.com/info" />
        <div class="help">No affiliate links in the Craigslist ad. Disclose any affiliations on your site.</div>
        <label>Notes</label><input id="notes" placeholder="e.g., Call 07 5555 0123 between 9–5 AEST" />
        <div class="actions"><button id="generate">Generate Ad</button><button id="make3" class="alt">Make 3 Variants</button><button id="clear" class="ghost">Clear</button></div>
      </div>

      <div class="card">
        <h2>Compliance Checklist</h2>
        <div class="checklist" id="checklist"></div>
        <div class="muted small">This helper encourages best-practice, compliant posts. Always review current Craigslist Terms of Use and local laws.</div>
      </div>
    </div>

    <div class="card">
      <h2>AI Idea → Craigslist-Compliant Ad</h2>
      <div class="help">Type a simple idea like “make money online from home” or “affiliate marketing”. We’ll convert it into a compliant ad.</div>
      <div class="row">
        <div><label>One-Line Idea</label><input id="idea" placeholder="e.g., make money online from home" /></div>
        <div><label>Vertical</label><select id="vertical">
          <option value="bizop">Business / Side Income (info only)</option>
          <option value="home_services">Home Services</option>
          <option value="finance">Personal Finance Tips</option>
          <option value="education">Courses / Skills (info)</option>
        </select></div>
      </div>
      <div class="actions"><button id="compose">Auto-Compose Compliant Ad</button></div>
      <div class="muted small">We’ll fill Ad Details and generate the copy. You can still tweak tone/length.</div>
    </div>

    <div class="card">
      <h2>UTM Builder (Unique Tracking Links)</h2>
      <div class="row">
        <div><label>Base Info Page URL</label><input id="utm_base" placeholder="https://yourdomain.com/info" /></div>
        <div><label>Campaign Name</label><input id="utm_campaign" placeholder="e.g., pest-guide-q4" /></div>
      </div>
      <div class="row">
        <div><label>Source</label><input id="utm_source" value="craigslist" /></div>
        <div><label>Medium</label><input id="utm_medium" value="classified" /></div>
      </div>
      <label>Term (auto from city/offer if blank)</label><input id="utm_term" placeholder="e.g., brisbane-pest" />
      <div class="actions"><button id="buildUtm">Build UTM Link</button><button id="copyUtm" class="ghost">Copy</button></div>
      <div id="utm_out" class="muted" style="margin-top:8px;word-break:break-all"></div>
    </div>

    <div class="card">
      <h2>Market Insights (Paste Data → Rank Winners)</h2>
      <div class="help">Paste CSV: <span class="mono">country,state,zip,offer_type,posts,clicks,leads,sales[,weekday,hour]</span></div>
      <textarea id="csv" placeholder="country,state,zip,offer_type,posts,clicks,leads,sales
US,Texas,77002,Pest Guide,12,84,19,4
AU,QLD,4000,Home Solar Info,6,42,11,2"></textarea>
      <div class="actions"><button id="analyze">Analyze Data</button><button id="demoFill" class="alt">Load Demo Data</button><button id="clearCsv" class="ghost">Clear</button></div>
      <div id="insights" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <h2>Heatmap & Best Posting Windows</h2>
      <div class="help">Provide weekday/hour in CSV or via /api/metrics to derive best windows.</div>
      <div id="heat_summary" class="muted" style="margin-top:8px">Load data to see summaries here.</div>
      <div id="heatmap_grid" class="small" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>Automation Settings (Zero-Touch Analytics)</h2>
      <div class="help">Point to your /api/metrics URL. The app will auto-pull and refresh Insights.</div>
      <div class="row">
        <div><label>Data Endpoint (JSON)</label><input id="auto_endpoint" placeholder="https://yourapp.vercel.app/api/metrics" /></div>
        <div><label>API Key (optional)</label><input id="auto_key" placeholder="e.g., sk_live_xxx" /></div>
      </div>
      <div class="row">
        <div><label>Refresh (minutes)</label><input id="auto_minutes" type="number" min="1" value="10" /></div>
        <div>
          <label>&nbsp;</label>
          <div class="actions"><button id="auto_start">Start Auto-Pull</button><button id="auto_stop" class="ghost">Stop</button></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Creative Hints (From Trends)</h2>
      <div class="help">Indirect, legal momentum (public sources). Configure proxies below.</div>
      <div id="tr_hints" class="variants"></div>
    </div>

    <div class="card">
      <h2>Trends Settings (Indirect, Legal Signals)</h2>
      <div class="help">Use public APIs (no Craigslist access) to guide angles/regions.</div>
      <div class="row">
        <div><label>Topics</label><input id="tr_topics" placeholder="side income, home solar, pest control" /></div>
        <div><label>Regions</label><input id="tr_regions" placeholder="US, AU-QLD, US-TX" /></div>
      </div>
      <div class="row">
        <div><label>Trends Proxy URL</label><input id="tr_trends_url" placeholder="https://yourapp.vercel.app/api/trends" /></div>
        <div><label>News Proxy URL (optional)</label><input id="tr_news_url" placeholder="https://yourapp.vercel.app/api/news" /></div>
      </div>
      <div class="row">
        <div><label>YouTube Proxy URL (optional)</label><input id="tr_yt_url" placeholder="https://yourapp.vercel.app/api/youtube" /></div>
        <div><label>Refresh (minutes)</label><input id="tr_minutes" type="number" min="5" value="30" /></div>
      </div>
      <div class="actions"><button id="tr_start">Start Trend Pull</button><button id="tr_stop" class="ghost">Stop</button></div>
      <div id="tr_summary" class="muted" style="margin-top:8px">Trends will appear here.</div>
    </div>

    <div class="card">
      <h2>Your Generated Ad</h2>
      <textarea id="output" placeholder="Generated ad text will appear here…"></textarea>
      <div class="actions"><button id="copy">Copy Ad</button><button id="select">Select All</button></div>
      <div id="variants" class="variants"></div>
    </div>

    <div class="card">
      <h2>Auto Posting Plan (Suggested)</h2>
      <div class="help">Generates a weekly schedule using your top regions & windows.</div>
      <div class="actions"><button id="plan_generate">Generate Plan</button><button id="plan_copy" class="ghost">Copy Plan</button><button id="plan_csv" class="ghost">Export CSV</button><button id="plan_ics" class="ghost">Export ICS</button></div>
      <pre id="plan_out" class="small" style="white-space:pre-wrap;background:#0b1222;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.08)"></pre>
    </div>

    <div class="card">
      <h2>Variant Evolution</h2>
      <div class="help">Creates fresh variants biased toward what’s performing (compliant).</div>
      <div class="actions"><button id="evolve">Evolve Variants</button></div>
      <div id="evolve_box" class="variants"></div>
    </div>

    <div class="muted small" style="text-align:center;margin-top:10px">
      <span class="mono">MVP</span> — compliant, no scraping. Use your data + public trends.
    </div>
  </div>

<script>
const el = id => document.getElementById(id);

// Compliance & generator

async function serverModerate(text){
  try{
    const r = await fetch('/api/admin/moderate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text })});
    if(!r.ok) return { ok:false, blocked:false, flags:[] };
    return await r.json();
  }catch(e){ return { ok:false, blocked:false, flags:[] }; }
}
function showModerationFlags(flags){
  const box = document.getElementById('variants');
  if (!box) return;
  const d = document.createElement('div');
  d.className = 'variant';
  d.innerHTML = `<div class="muted small">Moderation flags</div>` + (flags.length? `<ul>${flags.map(f=>`<li><strong>${f.rule}</strong>: ${f.snippet}</li>`).join('')}</ul>` : '<div>No issues detected.</div>');
  box.prepend(d);
}

function complianceState({ url, category, notes }) {
  const items = [];
  const ownDomain = url && /^(https?:\/\/)?([a-z0-9-]+\.)+[a-z]{2,}(\/[\w\-./?%&=]*)?$/i.test(url);
  const looksAff = url && /(\baff\b|ref=|hop=|clickbank|linkshare|cj\.com|impact\.com|shareasale|partner)/i.test(url);
  items.push({label:'No affiliate links in ad body', state: looksAff ? 'bad':'ok', hint: looksAff?'URL looks like an affiliate link — remove it.':'Good: no affiliate link in ad.'});
  items.push({label:'Use appropriate category', state: (/jobs/.test(category))?'warn':'ok', hint: (/jobs/.test(category))?'Jobs is for employers only.':'Category looks reasonable.'});
  items.push({label:'Real contact path', state: (notes?.trim()?'ok':'warn'), hint: (notes?.trim()?'Clear contact provided.':'Optional: add phone/email in Notes or use “Reply”.')});
  items.push({label:'Route to your own info page', state: ownDomain?'ok':'warn', hint: ownDomain?'Looks like a normal website.':'If you include a URL, use your own site (not an affiliate link).'});
  return items;
}
function setChecklist(items){
  const c = el('checklist'); c.innerHTML = '';
  items.forEach(it=>{
    const div = document.createElement('div'); div.className='item';
    const dot = document.createElement('div'); dot.className = 'dot '+it.state;
    const span = document.createElement('div'); span.innerHTML = `<strong>${it.label}</strong><div class="small muted">${it.hint}</div>`;
    div.append(dot, span); c.append(div);
  });
}
function titleFrom(tone, problem, city){
  const base = problem || 'Local help available';
  const cityTag = city ? ` – ${city}` : '';
  const v = {
    plain:[`${base}${cityTag}`, `Need help? ${base}${cityTag}`, `${base}: quick info${cityTag}`],
    friendly:[`Hey ${city||'there'} – quick help for ${base.toLowerCase()}`, `${city||'Local'} help for ${base.toLowerCase()}`, `Friendly help: ${base.toLowerCase()}${cityTag}`],
    urgent:[`${base} today${cityTag}`, `Need ${base.toLowerCase()} ASAP?${cityTag}`, `${base}! Limited slots${cityTag}`],
    professional:[`${base} – verified info & options${cityTag}`, `${base}: speak with someone local${cityTag}`, `${base}: clear, unbiased guidance${cityTag}`]
  }[tone||'plain'];
  return v[Math.floor(Math.random()*v.length)];
}
function buildAd({ city, category, offer, problem, solution, tone, contact, url, notes, length }){
  const title = titleFrom(tone, problem, city);
  const intro = `We’re offering ${offer||'helpful, no-pressure information'} for ${problem||'locals who need a quick answer'}.`;
  const value = solution ? `Here’s what you get: ${solution}.` : `Get clear next steps and options in minutes.`;
  const contactLine = (contact==='reply') ? `Reply to this ad and we’ll send the info.` :
                      (contact==='call') ? `Call/Text: ${notes||'Add your number in Notes.'}` :
                                           `Email: ${notes||'Add your email in Notes.'}`;
  const urlLine = url?.trim()? `Optional info page: ${url.trim()} (no sales page – just details).` : '';
  const locality = city? `Serving ${city} and nearby areas.` : '';
  const bodyShort = [intro, value, contactLine, urlLine, locality].filter(Boolean).join('\n');
  const bodyLong  = [intro,'','- No hard sales, just plain English info','- Options matched to your situation','- Quick response during business hours','',value,'',contactLine,urlLine,locality].filter(Boolean).join('\n');
  const body = length==='short'? bodyShort : (length==='long'? bodyLong : (bodyShort+'\n\n'+bodyLong));
  const disclaimer='\n\nNote: We do not post affiliate links on Craigslist. If our info page contains affiliate relationships, they are disclosed clearly there.\n';
  return `${title}\n\n${body}${disclaimer}`.trim();
}
function generate(n=1){
  const data = {
    city: el('city').value.trim(), category: el('category').value, offer: el('offer').value.trim(),
    problem: el('problem').value.trim(), solution: el('solution').value.trim(), tone: el('tone').value,
    contact: el('contact').value, url: el('url').value.trim(), notes: el('notes').value.trim(), length: el('length').value
  };
  setChecklist(complianceState(data));
  const out=[]; for(let i=0;i<n;i++){ out.push(buildAd(data)); }
  return out;
}
el('generate').addEventListener('click', async ()=>{ const [one]=generate(1); if(!one) return; const m=await serverModerate(one); el('variants').innerHTML=''; if(m.blocked){ showModerationFlags(m.flags); alert('Ad blocked by moderation. Please revise.'); return; } el('output').value=one; showModerationFlags(m.flags||[]); });
el('make3').addEventListener('click', async ()=>{ const list=generate(3); const first=list[0]; const m=await serverModerate(first); const box=el('variants'); box.innerHTML=''; if(m.blocked){ showModerationFlags(m.flags); alert('Ad blocked by moderation. Please revise.'); return; } el('output').value=first||''; list.slice(1).forEach((txt,i)=>{ const d=document.createElement('div'); d.className='variant'; d.innerHTML=`<div class="muted small">Variant ${i+2}</div><textarea style="width:100%;min-height:140px;background:#0b1222;color:#e5e7eb;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px">${txt}</textarea>`; box.append(d); }); showModerationFlags(m.flags||[]); });
el('copy').addEventListener('click', async ()=>{ const txt=el('output').value; if(!txt) return; try{ await navigator.clipboard.writeText(txt); alert('Copied'); }catch(e){ el('output').select(); document.execCommand('copy'); alert('Copied (fallback)'); }});
el('select').addEventListener('click', ()=>{ el('output').focus(); el('output').select(); });
el('clear').addEventListener('click', ()=>{ ['city','offer','problem','solution','url','notes','idea','utm_base','utm_campaign','utm_term','tr_topics','tr_regions','tr_trends_url','tr_news_url','tr_yt_url'].forEach(id=>{ if(el(id)) el(id).value=''; }); el('tone').value='professional'; el('length').value='normal'; el('category').value='services'; el('contact').value='reply'; el('output').value=''; el('variants').innerHTML=''; el('checklist').innerHTML=''; el('insights').innerHTML=''; el('heat_summary').textContent=''; });

// AI Idea → Compliant
function normalizeIdea(idea){
  const banned=[/guaranteed/i,/get rich/i,/fast cash/i,/no work/i,/loophole/i];
  let clean=(idea||''); banned.forEach(rx=>{ clean=clean.replace(rx,'').trim(); });
  clean=clean.replace(/make money online/gi,'earn from home').replace(/affiliate marketing/gi,'referral-based recommendations');
  return clean.replace(/\s{2,}/g,' ').trim();
}
function ideaToOffer(idea, vertical){
  normalizeIdea(idea);
  if(vertical==='bizop') return { offer:'Free intro guide + short call about local side-income options', problem:'people looking for flexible, legit ways to earn from home', solution:'Plain-English steps, time estimates, and tools; no promises, just options' };
  if(vertical==='home_services') return { offer:'Free local info guide + provider options', problem:'homeowners needing trustworthy help fast', solution:'Compare vetted options and get next steps without pressure' };
  if(vertical==='finance') return { offer:'Simple tips guide + resource list', problem:'residents looking to organize debt/budget better', solution:'Clear steps, worksheets, and links to reputable resources' };
  return { offer:'Short info guide + Q&A', problem:'locals looking for clear direction', solution:'Step-by-step outline and neutral resources' };
}
function composeFromIdea(){
  const idea = el('idea').value.trim(); if(!idea){ alert('Enter an idea first'); return; }
  const vertical = el('vertical').value;
  const o = ideaToOffer(idea, vertical);
  el('offer').value=o.offer; el('problem').value=o.problem; el('solution').value=o.solution;
  el('tone').value='professional'; el('length').value='normal';
  const [txt]=generate(1); el('output').value=txt||'';
  const data={ city:el('city').value.trim(), category:el('category').value, offer:o.offer, problem:o.problem, solution:o.solution, tone:el('tone').value, contact:el('contact').value, url:el('url').value.trim(), notes:el('notes').value.trim(), length:el('length').value };
  setChecklist(complianceState(data));
}
document.getElementById('compose').addEventListener('click', async ()=>{ composeFromIdea(); const txt = el('output').value; const m=await serverModerate(txt); if(m.blocked){ showModerationFlags(m.flags); alert('Ad blocked by moderation. Please revise.'); } else { showModerationFlags(m.flags||[]); } });

// UTM Builder
function slugify(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function buildUTM(){
  const base=el('utm_base').value.trim(); if(!base){ el('utm_out').textContent='Enter a base URL first.'; return; }
  const city=el('city').value.trim(); const offer=el('offer').value.trim();
  const campaign=el('utm_campaign').value.trim()||slugify(`${offer}-campaign`);
  const source=el('utm_source').value.trim()||'craigslist';
  const medium=el('utm_medium').value.trim()||'classified';
  const term=el('utm_term').value.trim()||slugify(`${city}-${offer}`);
  const cid=Math.random().toString(36).slice(2,8);
  const url=new URL(base); url.searchParams.set('utm_source',source); url.searchParams.set('utm_medium',medium); url.searchParams.set('utm_campaign',campaign); url.searchParams.set('utm_term',term); url.searchParams.set('cid',cid);
  el('utm_out').textContent=url.toString();
}
document.getElementById('buildUtm').addEventListener('click', buildUTM);
document.getElementById('copyUtm').addEventListener('click', async()=>{ const s=el('utm_out').textContent.trim(); if(!s) return; try{ await navigator.clipboard.writeText(s); alert('UTM link copied'); }catch(e){} });

// Insights CSV analyzer
function parseCSV(text){
  const rows=text.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
  const header=rows.shift()||[]; const idx=h=>header.findIndex(x=>x.toLowerCase().trim()===h);
  const iCountry=idx('country'), iState=idx('state'), iZip=idx('zip'), iOffer=idx('offer_type'), iPosts=idx('posts'), iClicks=idx('clicks'), iLeads=idx('leads'), iSales=idx('sales'), iWeek=idx('weekday'), iHour=idx('hour');
  if([iCountry,iState,iZip,iOffer,iPosts,iClicks,iLeads,iSales].some(i=>i<0)) return {error:'Missing one or more required columns.'};
  const data=rows.map(r=>({ country:r[iCountry]||'', state:r[iState]||'', zip:r[iZip]||'', offer_type:r[iOffer]||'', posts:+(r[iPosts]||0), clicks:+(r[iClicks]||0), leads:+(r[iLeads]||0), sales:+(r[iSales]||0), weekday: iWeek>=0? +(r[iWeek]||''): undefined, hour: iHour>=0? +(r[iHour]||''): undefined }));
  return {data};
}
function scoreRow(r){
  const ctr=r.posts>0? r.clicks/Math.max(1,r.posts):0;
  const lcr=r.clicks>0? r.leads/Math.max(1,r.clicks):0;
  const scr=r.leads>0? r.sales/Math.max(1,r.leads):0;
  const scale=Math.log10(1+(r.clicks||0))+Math.log10(1+(r.leads||0));
  const score=(ctr*30 + lcr*40 + scr*60) * (0.6 + 0.4*Math.min(1, scale/2));
  return {ctr,lcr,scr,score:Math.round(score*100)/100};
}
function aggregate(data, keyFn){
  const map=new Map();
  for(const r of data){ const key=keyFn(r); const acc=map.get(key)||{posts:0,clicks:0,leads:0,sales:0}; acc.posts+=r.posts; acc.clicks+=r.clicks; acc.leads+=r.leads; acc.sales+=r.sales; map.set(key,acc); }
  const out=[]; for(const [key,v] of map.entries()){ const s=scoreRow(v); out.push({key, ...v, ...s}); }
  out.sort((a,b)=>b.score-a.score); return out;
}
function tableHTML(rows,title){
  if(!rows.length) return '';
  const head=`<tr><th>${title}</th><th>Posts</th><th>Clicks</th><th>Leads</th><th>Sales</th><th>Score</th><th class="small">CTR</th><th class="small">Lead/Click</th><th class="small">Sale/Lead</th></tr>`;
  const body=rows.slice(0,10).map(r=>`<tr><td>${r.key}</td><td>${r.posts}</td><td>${r.clicks}</td><td>${r.leads}</td><td>${r.sales}</td><td>${r.score}</td><td>${(r.ctr*100).toFixed(1)}%</td><td>${(r.lcr*100).toFixed(1)}%</td><td>${(r.scr*100).toFixed(1)}%</td></tr>`).join('');
  return `<div style="overflow:auto;border:1px solid rgba(255,255,255,.1);border-radius:10px;margin-top:8px"><table style="width:100%;border-collapse:collapse">${head}${body}</table></div>`;
}
function renderHeatmapFromData(data){
  const grid = document.getElementById('heatmap_grid'); if(!grid) return;
  const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const counts = Array.from({length:7},()=>Array.from({length:24},()=>0));
  data.forEach(r=>{
    const d = (typeof r.weekday !== 'undefined') ? (+r.weekday||0) : null;
    const h = (typeof r.hour !== 'undefined') ? (+r.hour||0) : null;
    if(d!==null && h!==null) counts[d][h] += (r.clicks||0);
  });
  const maxVal = Math.max(1, ...counts.flat());
  let html = '<div class="heat-grid">';
  html += '<div></div>'; for(let h=0; h<24; h++){ html += `<div class="heat-label">${h}</div>`; }
  for(let d=0; d<7; d++){
    html += `<div class="heat-label">${dayNames[d]}</div>`;
    for(let h=0; h<24; h++){
      const v = counts[d][h]; const alpha = v ? (0.15 + 0.85*(v/maxVal)) : 0.08;
      html += `<div class="heat-cell" style="background: rgba(34,211,238,${alpha});"></div>`;
    }
  }
  html += '</div>'; grid.innerHTML = html;
}
function analyzeCSV(){
  const raw=el('csv').value; const box=el('insights');
  if(!raw.trim()){ box.innerHTML='<div class="muted">Paste CSV data to analyze.</div>'; return; }
  const parsed=parseCSV(raw); if(parsed.error){ box.innerHTML=`<div class='muted'>${parsed.error}</div>`; return; }
  const data=parsed.data;
  const byCountry=aggregate(data, r=>r.country||'(unknown)');
  const byState=aggregate(data, r=>(r.country? r.country+': ':'')+(r.state||'(unknown)'));
  const byZip=aggregate(data, r=>(r.state? r.state+' ':'')+(r.zip||'(unknown)'));
  const byOffer=aggregate(data, r=>r.offer_type||'(unknown)'));
  const hasHour=data.some(r=> typeof r.hour!=='undefined');
  const hasWeek=data.some(r=> typeof r.weekday!=='undefined');
  if(hasHour || hasWeek){
    const hourCounts=Array.from({length:24},()=>0); const dayCounts=Array.from({length:7},()=>0);
    data.forEach(r=>{ if(typeof r.hour!=='undefined') hourCounts[+r.hour|0]+= (r.clicks||0); if(typeof r.weekday!=='undefined') dayCounts[+r.weekday|0]+= (r.clicks||0); });
    const bestHours=[...hourCounts].map((v,i)=>({h:i,v})).sort((a,b)=>b.v-a.v).slice(0,3).map(x=>`${x.h}:00`);
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const bestDays=[...dayCounts].map((v,i)=>({d:dayNames[i],v})).sort((a,b)=>b.v-a.v).slice(0,3).map(x=>x.d);
    el('heat_summary').innerHTML = `<div><strong>Top posting windows</strong>: ${bestDays.join(', ')} @ ${bestHours.join(', ')}</div>`;
    renderHeatmapFromData(data);
  }
  box.innerHTML = `<div class="muted">Top performers (weighted by engagement & conversion quality)</div>${tableHTML(byCountry,'Country')}${tableHTML(byState,'State/Region')}${tableHTML(byZip,'ZIP/Postal')}${tableHTML(byOffer,'Offer Type')}`;
}
document.getElementById('analyze').addEventListener('click', analyzeCSV);
document.getElementById('demoFill').addEventListener('click', ()=>{ el('csv').value=`country,state,zip,offer_type,posts,clicks,leads,sales,weekday,hour
US,Texas,77002,Pest Guide,12,84,19,4,2,14
US,California,94103,Debt Tips,9,61,7,1,3,15
US,Florida,33130,Roof Repair Info,10,71,16,2,4,13
AU,QLD,4000,Home Solar Info,6,42,11,2,2,11
AU,NSW,2000,Pest Guide,7,38,9,1,1,9
UK,England,SW1A 1AA,Debt Tips,5,29,6,1,3,10
US,Texas,77007,Home Solar Info,8,50,12,3,2,16
US,Arizona,85004,Roof Repair Info,6,39,7,1,5,12
CA,BC,V6B 1A1,Pest Guide,5,36,8,1,0,17`; analyzeCSV(); });
document.getElementById('clearCsv').addEventListener('click', ()=>{ el('csv').value=''; el('insights').innerHTML=''; el('heat_summary').textContent=''; el('heatmap_grid').innerHTML=''; });

// Auto-pull metrics
let __autoTimer=null;
async function pullMetricsOnce(){
  const url=el('auto_endpoint').value.trim(); if(!url){ alert('Enter Data Endpoint URL'); return; }
  try{
    const headers={}; const k=(el('auto_key').value||'').trim(); if(k) headers['x-api-key']=k;
    const res=await fetch(url,{headers}); if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json(); renderInsightsFromData(data);
  }catch(e){ console.error('Auto-pull error',e); }
}
function renderInsightsFromData(data){
  if(!Array.isArray(data)||!data.length){ el('insights').innerHTML='<div class="muted">No data yet.</div>'; return; }
  const byCountry=aggregate(data, r=>r.country||'(unknown)');
  const byState=aggregate(data, r=>(r.country? r.country+': ':'')+(r.state||'(unknown)'));
  const byZip=aggregate(data, r=>(r.state? r.state+' ':'')+(r.zip||'(unknown)'));
  const byOffer=aggregate(data, r=>r.offer_type||r.offer||'(unknown)'));
  const hasHour=data.some(r=> typeof r.hour!=='undefined');
  const hasWeek=data.some(r=> typeof r.weekday!=='undefined');
  if(hasHour||hasWeek){
    const hourCounts=Array.from({length:24},()=>0); const dayCounts=Array.from({length:7},()=>0);
    data.forEach(r=>{ if(typeof r.hour!=='undefined') hourCounts[+r.hour|0]+=(r.clicks||0); if(typeof r.weekday!=='undefined') dayCounts[+r.weekday|0]+=(r.clicks||0); });
    const bestHours=[...hourCounts].map((v,i)=>({h:i,v})).sort((a,b)=>b.v-a.v).slice(0,3).map(x=>`${x.h}:00`);
    const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const bestDays=[...dayCounts].map((v,i)=>({d:dayNames[i],v})).sort((a,b)=>b.v-a.v).slice(0,3).map(x=>x.d);
    el('heat_summary').innerHTML = `<div><strong>Top posting windows</strong>: ${bestDays.join(', ')} @ ${bestHours.join(', ')}</div>`;
    renderHeatmapFromData(data);
  }
  el('insights').innerHTML = `<div class="muted">Top performers (weighted by engagement & conversion quality)</div>${tableHTML(byCountry,'Country')}${tableHTML(byState,'State/Region')}${tableHTML(byZip,'ZIP/Postal')}${tableHTML(byOffer,'Offer Type')}`;
}
function startAutoPull(){ const mins=Math.max(1,parseInt(el('auto_minutes').value||'10',10)); clearInterval(__autoTimer); pullMetricsOnce(); __autoTimer=setInterval(pullMetricsOnce, mins*60*1000); }
function stopAutoPull(){ clearInterval(__autoTimer); __autoTimer=null; }
el('auto_start').addEventListener('click', startAutoPull);
el('auto_stop').addEventListener('click', stopAutoPull);

// Trends auto-pull
let __trendTimer=null;
async function pullTrendsOnce(){
  const topics=el('tr_topics').value.trim(), regions=el('tr_regions').value.trim();
  const trendsUrl=el('tr_trends_url').value.trim(), newsUrl=el('tr_news_url').value.trim(), ytUrl=el('tr_yt_url').value.trim();
  if(!topics||!regions||!trendsUrl){ el('tr_summary').textContent='Enter topics, regions, and trends URL.'; return; }
  try{
    const q=new URLSearchParams({topics,regions}).toString();
    const [trRes, nwRes, ytRes]=await Promise.all([
      fetch(trendsUrl+'?'+q),
      newsUrl? fetch(newsUrl+'?'+q): Promise.resolve({ok:true,json:async()=>[]}), 
      ytUrl? fetch(ytUrl+'?'+new URLSearchParams({topics}).toString()): Promise.resolve({ok:true,json:async()=>[]})
    ]);
    const tr=await trRes.json(); const nw=await nwRes.json(); const yt=await ytRes.json();
    const lines=[]; const hints=[];
    tr.forEach(row=>{ lines.push(`• ${row.topic} in ${row.region}: score ${row.score}/100 (${row.slope>=0?'+':''}${row.slope})`);
      hints.push({ title:`Looking for clear, local info on ${row.topic}?`, body:`We share a short guide with next steps in ${row.region}. No hype, just options and simple language. Reply to this ad for details.`}); });
    el('tr_summary').innerHTML = lines.length ? lines.join('<br/>') : 'No trend data.';
    const box=el('tr_hints'); box.innerHTML=''; hints.slice(0,6).forEach((h,i)=>{ const d=document.createElement('div'); d.className='variant'; d.innerHTML=`<div class="muted small">Hint ${i+1}</div><div><strong>${h.title}</strong></div><div class="small">${h.body}</div>`; box.append(d); });
  }catch(e){ el('tr_summary').textContent='Trend pull error.'; }
}
function startTrendPull(){ const mins=Math.max(5,parseInt(el('tr_minutes').value||'30',10)); clearInterval(__trendTimer); pullTrendsOnce(); __trendTimer=setInterval(pullTrendsOnce, mins*60*1000); }
function stopTrendPull(){ clearInterval(__trendTimer); __trendTimer=null; }
el('tr_start').addEventListener('click', startTrendPull);
el('tr_stop').addEventListener('click', stopTrendPull);

// Plan exports (CSV + ICS with AEST + RRULE)
function currentPlanLines(){
  const txt = document.getElementById('plan_out').textContent||'';
  const lines = txt.split('\n').filter(x=>x && !/^Weekly Posting Plan/.test(x));
  return lines;
}
function downloadFile(name, content, type='text/plain'){
  const blob = new Blob([content], {type});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
}
function exportPlanCSV(){
  const lines = currentPlanLines();
  const rows = [['day','time','geo']];
  lines.forEach(l=>{
    const m = l.match(/-\s+(\w+)\s+@\s+([0-9:]+)\s+\u2192\s+Post 1 ad in\s+(.+)/);
    if(m){ rows.push([m[1], m[2], m[3]]); }
  });
  const csv = rows.map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  downloadFile('posting-plan.csv', csv, 'text/csv');
}
function exportPlanICS(){
  const lines = currentPlanLines();
  if(!lines.length){ alert('Generate a plan first.'); return; }
  const dayMap = {Sun:'SU', Mon:'MO', Tue:'TU', Wed:'WE', Thu:'TH', Fri:'FR', Sat:'SA'};
  const tzid = 'Australia/Brisbane';
  const tzblock = [
    'BEGIN:VTIMEZONE','TZID:Australia/Brisbane','X-LIC-LOCATION:Australia/Brisbane',
    'BEGIN:STANDARD','TZOFFSETFROM:+1000','TZOFFSETTO:+1000','TZNAME:AEST','DTSTART:19700101T000000','END:STANDARD','END:VTIMEZONE'
  ].join('\n');
  function nextDowDate(dow){
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; const now = new Date();
    let diff = days.indexOf(dow) - now.getDay(); if (diff < 0) diff += 7;
    return new Date(now.getFullYear(), now.getMonth(), now.getDate()+diff);
  }
  function fmtLocal(dt){ const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), d=String(dt.getDate()).padStart(2,'0'); const hh=String(dt.getHours()).padStart(2,'0'), mm=String(dt.getMinutes()).padStart(2,'0'); return `${y}${m}${d}T${hh}${mm}00`; }
  let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Compliant Ad Assistant//EN\n' + tzblock + '\n';
  lines.forEach((l,i)=>{
    const m = l.match(/-\s+(\w+)\s+@\s+([0-9:]+)\s+\u2192\s+Post 1 ad in\s+(.+)/); if(!m) return;
    const day=m[1], time=m[2], geo=m[3]; const [hh,mm]=time.split(':').map(n=>parseInt(n,10));
    const startDate = nextDowDate(day); startDate.setHours(hh, mm||0, 0, 0); const endDate = new Date(startDate.getTime()+30*60000);
    const uid = `plan-${Date.now()}-${i}@ad-assistant`;
    ics += 'BEGIN:VEVENT\n';
    ics += `UID:${uid}\n`;
    ics += `DTSTAMP:${fmtLocal(new Date())}Z\n`;
    ics += `DTSTART;TZID=${tzid}:${fmtLocal(startDate)}\n`;
    ics += `DTEND;TZID=${tzid}:${fmtLocal(endDate)}\n`;
    ics += `RRULE:FREQ=WEEKLY;COUNT=4;BYDAY=${dayMap[day]||'MO'}\n`;
    ics += `SUMMARY:Craigslist Post – ${geo}\n`;
    ics += 'END:VEVENT\n';
  });
  ics += 'END:VCALENDAR\n'; downloadFile('posting-plan.ics',''+ics,'text/calendar');
}
document.getElementById('plan_csv').addEventListener('click', exportPlanCSV);
document.getElementById('plan_ics').addEventListener('click', exportPlanICS);

// Auto posting plan
function topKeysFromInsights(title){
  const html = el('insights')?.innerHTML || ''; const section = html.split(title)[1] || '';
  return [...section.matchAll(/<tr><td>(.*?)<\/td>/g)].slice(0,5).map(m=>m[1]);
}
function generatePlan(){
  const heat=el('heat_summary')?.innerText||'';
  const timesMatch=heat.match(/@ (.+)$/); const times=timesMatch? timesMatch[1].split(',').map(s=>s.trim()): ['10:00','14:00','18:00'];
  const daysMatch=heat.match(/Top posting windows.*?: (.*) @/); const days=daysMatch? daysMatch[1].split(',').map(s=>s.trim()): ['Mon','Wed','Fri'];
  const topStates=topKeysFromInsights('State/Region'); const topZips=topKeysFromInsights('ZIP/Postal');
  const lines=['Weekly Posting Plan (suggested):'];
  days.forEach((d,i)=>{ const slot=times[i%times.length]; const geo=(i%2===0? (topStates[i%topStates.length]||'Any State'):(topZips[i%topZips.length]||'Any ZIP')); lines.push(`- ${d} @ ${slot} → Post 1 ad in ${geo}`); });
  el('plan_out').textContent=lines.join('\n');
}
el('plan_generate').addEventListener('click', generatePlan);
el('plan_copy').addEventListener('click', async()=>{ const s=el('plan_out').textContent||''; if(!s) return; try{ await navigator.clipboard.writeText(s); alert('Plan copied'); }catch(e){} });
</script>
</body>
</html>